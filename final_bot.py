import os
import asyncio
from datetime import datetime, timedelta
from dotenv import load_dotenv
import google.generativeai as genai
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from langdetect import detect

# =======================
# LOAD ENV
# =======================
load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

if not BOT_TOKEN or not GEMINI_API_KEY:
    raise RuntimeError("BOT_TOKEN –∏–ª–∏ GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω")

# =======================
# GEMINI INIT
# =======================
genai.configure(api_key=GEMINI_API_KEY)

MODELS_PRIORITY = [
    "gemini-2.5-flash-lite", 
    "gemini-1.5-flash",
    "gemini-1.5-flash-latest",
]

CURRENT_MODEL = None

# =======================
# RATE LIMITING
# =======================
class RateLimiter:
    def __init__(self, max_requests=10, time_window=60):
        """
        max_requests: –º–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤
        time_window: –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        """
        self.max_requests = max_requests
        self.time_window = time_window
        self.requests = {}
    
    def can_request(self, user_id):
        now = datetime.now()
        
        if user_id not in self.requests:
            self.requests[user_id] = []
        
        self.requests[user_id] = [
            req_time for req_time in self.requests[user_id]
            if now - req_time < timedelta(seconds=self.time_window)
        ]
        
        if len(self.requests[user_id]) >= self.max_requests:
            return False, self.get_wait_time(user_id)
        
        self.requests[user_id].append(now)
        return True, 0
    
    def get_wait_time(self, user_id):
        if user_id not in self.requests or not self.requests[user_id]:
            return 0
        
        oldest_request = min(self.requests[user_id])
        wait_until = oldest_request + timedelta(seconds=self.time_window)
        wait_seconds = (wait_until - datetime.now()).total_seconds()
        return max(0, int(wait_seconds))

rate_limiter = RateLimiter(max_requests=15, time_window=60)

# =======================
# BOT INIT
# =======================
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# =======================
# –ì–õ–û–°–°–ê–†–ò–ô –¢–ï–†–ú–ò–ù–û–í
# =======================
GLOSSARY = {
    # IT —Ç–µ—Ä–º–∏–Ω—ã
    "artificial intelligence": "–∂–∞—Å–∞–Ω–¥—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç",
    "machine learning": "–º–∞—à–∏–Ω–∞–ª—ã“õ –æ“õ—ã—Ç—É",
    "database": "–¥–µ—Ä–µ–∫—Ç–µ—Ä “õ–æ—Ä—ã / –¥–µ—Ä–µ–∫“õ–æ—Ä",
    "cloud computing": "–±“±–ª—Ç—Ç—ã –µ—Å–µ–ø—Ç–µ—É",
    "software": "–±–∞“ì–¥–∞—Ä–ª–∞–º–∞–ª—ã“õ “õ–∞–º—Ç–∞–º–∞—Å—ã–∑ –µ—Ç—É",
    "hardware": "–∞–ø–ø–∞—Ä–∞—Ç—Ç—ã“õ “õ–∞–º—Ç–∞–º–∞—Å—ã–∑ –µ—Ç—É",
    "algorithm": "–∞–ª–≥–æ—Ä–∏—Ç–º",
    "programming": "–ø—Ä–æ–≥—Ä–∞–º–º–∞–ª–∞—É",
    
    # –ë–∏–∑–Ω–µ—Å —Ç–µ—Ä–º–∏–Ω—ã
    "management": "–±–∞—Å“õ–∞—Ä—É / –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç",
    "marketing": "–º–∞—Ä–∫–µ—Ç–∏–Ω–≥",
    "business": "–±–∏–∑–Ω–µ—Å / –∫”ô—Å—ñ–ø–∫–µ—Ä–ª—ñ–∫",
    "investment": "–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è / —Å–∞–ª—ã–º",
    "profit": "–ø–∞–π–¥–∞ / —Ç–∞–±—ã—Å",
    
    # –û–±—â–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
    "innovation": "–∏–Ω–Ω–æ–≤–∞—Ü–∏—è / –∂–∞“£–∞–ª—ã“õ",
    "development": "–¥–∞–º—É / –¥–∞–º—ã—Ç—É",
    "research": "–∑–µ—Ä—Ç—Ç–µ—É",
    "analysis": "—Ç–∞–ª–¥–∞—É",
    "system": "–∂“Ø–π–µ",
}

# =======================
# FEW-SHOT –ü–†–ò–ú–ï–†–´
# =======================
FEW_SHOT_EXAMPLES = """
–ú–´–°–ê–õ–î–ê–†:

“ö–∞–∑–∞“õ: –ú–µ–Ω—ñ“£ –∫—ñ—Ç–∞–ø–ª–∞—Ä—ã–º “Ø—Å—Ç–µ–ª–¥–µ –∂–∞—Ç—ã—Ä.
“ö–∞–∑–∞“õ: –ú–µ–Ω—ñ“£ –∫—ñ—Ç–∞–ø—Ç–∞—Ä—ã–º “Ø—Å—Ç–µ–ª–¥–µ –∂–∞—Ç—ã—Ä.

“ö–∞–∑–∞“õ: –ë—ñ–∑–¥—ñ“£ –º–µ–∫—Ç–µ–ø–¥–∞—Ä—ã–º—ã–∑ ”©—Ç–µ “Ø–ª–∫–µ–Ω.
“ö–∞–∑–∞“õ: –ë—ñ–∑–¥—ñ“£ –º–µ–∫—Ç–µ–ø—Ç–µ—Ä—ñ–º—ñ–∑ ”©—Ç–µ “Ø–ª–∫–µ–Ω.

–û—Ä—ã—Å: "–í—Ä–µ–º—è –ª–µ—Ç–∏—Ç –Ω–µ–∑–∞–º–µ—Ç–Ω–æ, –∫–æ–≥–¥–∞ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è –ª—é–±–∏–º—ã–º –¥–µ–ª–æ–º."
“ö–∞–∑–∞“õ (–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π): "–°“Ø–π—ñ–∫—Ç—ñ —ñ—Å—ñ“£–º–µ–Ω –∞–π–Ω–∞–ª—ã—Å“õ–∞–Ω–¥–∞ —É–∞“õ—ã—Ç “õ–∞–Ω–∞—Ç –∂–∞–π—ã–ø “±—à—ã–ø –∫–µ—Ç–µ–¥—ñ."

–û—Ä—ã—Å: "–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞."
“ö–∞–∑–∞“õ (–∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π): "–ú–∞—à–∏–Ω–∞–ª—ã“õ –æ“õ—ã—Ç—É ‚Äì –∂–∞—Å–∞–Ω–¥—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—Ç—ñ“£ –±—ñ—Ä –±”©–ª—ñ–º—ñ –±–æ–ª—ã–ø —Ç–∞–±—ã–ª–∞–¥—ã."

–û—Ä—ã—Å: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Å—É—â–µ—Å—Ç–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ –ø–æ–≤—ã—à–µ–Ω–∏—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."
“ö–∞–∑–∞“õ (–ø—Ä–æ—Å—Ç–æ–π): "–ñ“±–º—ã—Å—Ç—ã –∂–∞“õ—Å–∞—Ä—Ç—É “Ø—à—ñ–Ω —ñ—Å-—à–∞—Ä–∞ ”©—Ç–∫—ñ–∑—É –∫–µ—Ä–µ–∫."

English: "The company is implementing cutting-edge technology."
“ö–∞–∑–∞“õ (–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π): "–ö–æ–º–ø–∞–Ω–∏—è –æ–∑—ã“õ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–ª–∞—Ä–¥—ã –µ–Ω–≥—ñ–∑—É–¥–µ."

English: "Data analysis revealed significant patterns."
“ö–∞–∑–∞“õ (–∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π): "–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Ç–∞–ª–¥–∞—É –±–∞—Ä—ã—Å—ã–Ω–¥–∞ –∞–π—Ç–∞—Ä–ª—ã“õ—Ç–∞–π –∑–∞“£–¥—ã–ª—ã“õ—Ç–∞—Ä –∞–Ω—ã“õ—Ç–∞–ª–¥—ã."
"""

# =======================
# SYSTEM PROMPTS –î–õ–Ø –ö–ê–ñ–î–û–ì–û –†–ï–ñ–ò–ú–ê
# =======================
SYSTEM_PROMPTS = {
    "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π": f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Å —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –°–æ–∑–¥–∞–≤–∞—Ç—å —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–≥–∞—Ç—É—é –ª–µ–∫—Å–∏–∫—É –∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
- –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ —Ñ—Ä–∞–∑–µ–æ–ª–æ–≥–∏–∑–º—ã, –∞ –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –∏—Ö –¥–æ—Å–ª–æ–≤–Ω–æ
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –±–ª–∞–≥–æ–∑–≤—É—á–∏–µ–º –∏ —Ä–∏—Ç–º–∏–∫–æ–π —Ç–µ–∫—Å—Ç–∞

–í–ê–ñ–ù–û:
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –æ–±—Ä–∞–∑–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- –ò–∑–±–µ–≥–∞–π –∫–∞–ª–µ–∫ –∏ —Ä—É—Å–∏—Ü–∏–∑–º–æ–≤
- –°–æ—Ö—Ä–∞–Ω—è–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—É—é –Ω–æ—Ä–º—É –∫–∞–∑–∞—Ö—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- –î–ª—è —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π –≥–ª–æ—Å—Å–∞—Ä–∏–π –Ω–∏–∂–µ

–ì–õ–û–°–°–ê–†–ò–ô –¢–ï–†–ú–ò–ù–û–í:
{chr(10).join(f'"{k}" ‚Üí "{v}"' for k, v in GLOSSARY.items())}

{FEW_SHOT_EXAMPLES}

–ü–†–ê–í–ò–õ–ê –ü–ï–†–ï–í–û–î–ê –§–†–ê–ó–ï–û–õ–û–ì–ò–ó–ú–û–í:
"break the ice" ‚Üí "–º“±–∑–¥—ã –∂–∞—Ä—É"
"–≤—Ä–µ–º—è –ª–µ—Ç–∏—Ç" ‚Üí "—É–∞“õ—ã—Ç “±—à—ã–ø –±–∞—Ä–∞–¥—ã" / "—É–∞“õ—ã—Ç “õ–∞–Ω–∞—Ç –∂–∞–π—ã–ø “±—à—Ç—ã"
"–∑–æ–ª–æ—Ç—ã–µ —Ä—É–∫–∏" ‚Üí "–∞–ª—Ç—ã–Ω “õ–æ–ª" / "—à–µ–±–µ—Ä “õ–æ–ª"
"–¥–µ—Ä–∂–∞—Ç—å —Å–ª–æ–≤–æ" ‚Üí "—Å”©–∑—ñ–Ω–¥–µ —Ç“±—Ä—É"
"—Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞" ‚Üí "–∞“õ –±–µ—Ç –ø–∞—Ä–∞“õ—Ç–∞–Ω"
""",

    "–∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π": f"""–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –Ω–∞—É—á–Ω–æ–π –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –Ω–∞—É—á–Ω—ã–π —Å—Ç–∏–ª—å
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å—Ç–æ—è–≤—à—É—é—Å—è –∫–∞–∑–∞—Ö—Å–∫—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é
- –°–æ–±–ª—é–¥–∞—Ç—å –ª–æ–≥–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –ò–∑–±–µ–≥–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π

–¢–ï–†–ú–ò–ù–û–õ–û–ì–ò–Ø - –°–¢–†–û–ì–û –ò–°–ü–û–õ–¨–ó–£–ô –ì–õ–û–°–°–ê–†–ò–ô:
{chr(10).join(f'"{k}" ‚Üí "{v}"' for k, v in GLOSSARY.items())}

–°–¢–ò–õ–¨:
- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π –ø—Ä–∏—á–∞—Å—Ç–Ω—ã–µ –∏ –¥–µ–µ–ø—Ä–∏—á–∞—Å—Ç–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —Å–æ—é–∑–∞–º–∏
- –°–æ–±–ª—é–¥–∞–π –Ω–∞—É—á–Ω—É—é –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç—å
- –ò–∑–±–µ–≥–∞–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã "–±–æ–ª—ã–ø —Ç–∞–±—ã–ª–∞–¥—ã", "“õ–∞—Ä–∞—Å—Ç—ã—Ä—ã–ª–∞–¥—ã", "–∞–Ω—ã“õ—Ç–∞–ª–¥—ã"

{FEW_SHOT_EXAMPLES}

–°–¢–†–£–ö–¢–£–†–ê –ù–ê–£–ß–ù–û–ì–û –¢–ï–ö–°–¢–ê:
- –í–≤–µ–¥–µ–Ω–∏–µ: "–∑–µ—Ä—Ç—Ç–µ—É–¥—ñ“£ –º–∞“õ—Å–∞—Ç—ã", "–º—ñ–Ω–¥–µ—Ç—Ç–µ—Ä—ñ"
- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å: "—Ç–∞–ª–¥–∞—É –∫”©—Ä—Å–µ—Ç–∫–µ–Ω–¥–µ–π", "–Ω”ô—Ç–∏–∂–µ—Å—ñ–Ω–¥–µ"
- –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: "“õ–æ—Ä—ã—Ç—ã–Ω–¥—ã–ª–∞–π –∫–µ–ª–µ", "–∂–∞–ª–ø—ã–ª–∞–π –∫–µ–ª–≥–µ–Ω–¥–µ"
""",

    "–ø—Ä–æ—Å—Ç–æ–π": f"""–¢—ã –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π, –ø–æ–Ω—è—Ç–Ω—ã–π –∫–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫ –¥–ª—è —à–∏—Ä–æ–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –î–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ò–∑–±–µ–≥–∞—Ç—å —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∑–º–æ–≤
- –ü—Ä–∏–º–µ–Ω—è—Ç—å –æ–±—â–µ—É–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–π —Ä–µ—á–∏

–ü–†–ò–ù–¶–ò–ü–´:
- –†–∞–∑–±–∏–≤–∞–π —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ
- –ó–∞–º–µ–Ω—è–π –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∫–∞–∑–∞—Ö—Å–∫–∏–º–∏ –∞–Ω–∞–ª–æ–≥–∞–º–∏ –∏–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –≤–º–µ—Å—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
- –ü–∏—à–∏ —Ç–∞–∫, –∫–∞–∫ –≥–æ–≤–æ—Ä—è—Ç –æ–±—ã—á–Ω—ã–µ –ª—é–¥–∏

–ï–°–õ–ò –í–°–¢–†–ï–ß–ê–ï–®–¨ –¢–ï–†–ú–ò–ù:
{chr(10).join(f'"{k}" ‚Üí "{v}" (–∏–ª–∏ –æ–±—ä—è—Å–Ω–∏ –ø—Ä–æ—â–µ)' for k, v in list(GLOSSARY.items())[:5])}

{FEW_SHOT_EXAMPLES}

–ó–ê–ú–ï–ù–´ –°–õ–û–ñ–ù–´–• –°–õ–û–í:
"–æ—Å—É—â–µ—Å—Ç–≤–∏—Ç—å" ‚Üí "—ñ—Å—Ç–µ—É", "–∂–∞—Å–∞—É", "–æ—Ä—ã–Ω–¥–∞—É"
"–≤ —Ü–µ–ª—è—Ö –ø–æ–≤—ã—à–µ–Ω–∏—è" ‚Üí "–∂–∞“õ—Å–∞—Ä—Ç—É “Ø—à—ñ–Ω"
"–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ" ‚Üí "—ñ—Å-—à–∞—Ä–∞"
"—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å" ‚Üí "–æ—Ä—ã–Ω–¥–∞—É", "—ñ—Å–∫–µ –∞—Å—ã—Ä—É"
"–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è" ‚Üí "–∂–∞“õ—Å–∞—Ä—Ç—É"
"""
}

# =======================
# –ú–ï–ù–Æ INLINE –ö–ù–û–ü–û–ö
# =======================
def translation_modes_keyboard():
    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üìö ”ò–¥–µ–±–∏", callback_data="mode_literal"),
                InlineKeyboardButton(text="üéì –ê–∫–∞–¥–µ–º–∏—è–ª—ã“õ", callback_data="mode_academic"),
            ],
            [
                InlineKeyboardButton(text="üí¨ –ö“Ø–Ω–¥—ñ–ª–∫—Ç—ñ", callback_data="mode_simple")
            ]
        ]
    )
    return kb

def retry_keyboard(original_text):
    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="üîÑ “ö–∞–π—Ç–∞–¥–∞–Ω –∞—É–¥–∞—Ä—É", callback_data=f"retry_{hash(original_text)}")
            ],
            [
                InlineKeyboardButton(text="üìö ”ò–¥–µ–±–∏", callback_data="mode_literal"),
                InlineKeyboardButton(text="üéì –ê–∫–∞–¥–µ–º–∏—è–ª—ã“õ", callback_data="mode_academic"),
            ],
            [
                InlineKeyboardButton(text="üí¨ –ö“Ø–Ω–¥—ñ–ª–∫—Ç—ñ", callback_data="mode_simple")
            ]
        ]
    )
    return kb

# =======================
# –í–´–ë–û–† –ü–û–î–•–û–î–Ø–©–ï–ô –ú–û–î–ï–õ–ò
# =======================
async def select_best_model():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å"""
    global CURRENT_MODEL
    
    print("üîç “ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –º–æ–¥–µ–ª—å–¥—ñ“£ —ñ–∑–¥–µ–ª—ñ–Ω—É—ñ...")
    
    try:
        available_models = [m.name for m in genai.list_models() 
                          if 'generateContent' in m.supported_generation_methods]
        
        for model_name in MODELS_PRIORITY:
            full_name = f"models/{model_name}"
            if full_name in available_models:
                CURRENT_MODEL = model_name
                print(f"‚úÖ –ú–æ–¥–µ–ª—å —Ç–∞“£–¥–∞–ª–¥—ã: {model_name}")
                return True
        
        if available_models:
            CURRENT_MODEL = available_models[0].replace("models/", "")
            print(f"‚ö†Ô∏è “ö–æ–ª–¥–∞–Ω—ã–ª–∞—Ç—ã–Ω –º–æ–¥–µ–ª—å: {CURRENT_MODEL}")
            return True
            
    except Exception as e:
        print(f"‚ùå –ú–æ–¥–µ–ª—å–¥—ñ —Ç–∞“£–¥–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ–ª—ñ–∫: {e}")
    
    return False

# =======================
# –°–¢–ê–†–¢
# =======================
@dp.message(CommandStart())
async def start(message: types.Message):
    await message.answer(
        "üá∞üáø –°”ô–ª–µ–º! –ú–µ–Ω –º”ô—Ç—ñ–Ω–¥—ñ “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–µ –∞—É–¥–∞—Ä–∞–º—ã–Ω.\n\n"
        "üìù **–†–µ–∂–∏–º–¥–µ—Ä:**\n"
        "üìö **”ò–¥–µ–±–∏** ‚Äì –∫”©—Ä–∫–µ–º, –±–µ–π–Ω–µ–ª—ñ –∞—É–¥–∞—Ä–º–∞\n"
        "üéì **–ê–∫–∞–¥–µ–º–∏—è–ª—ã“õ** ‚Äì “ì—ã–ª—ã–º–∏, –¥”ô–ª –∞—É–¥–∞—Ä–º–∞\n"
        "üí¨ **–ö“Ø–Ω–¥–µ–ª—ñ–∫—Ç—ñ** ‚Äì —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç—ñ, –∂–µ“£—ñ–ª —Ç—ñ–ª\n\n"
        "‚ú® **–ú“Ø–º–∫—ñ–Ω–¥—ñ–∫—Ç–µ—Ä:**\n"
        "‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç—ñ–≥–µ —Å–∞–π –∞—É–¥–∞—Ä–º–∞\n"
        "‚Ä¢ –¢–µ—Ä–º–∏–Ω–¥–µ—Ä –º–µ–Ω —Ñ—Ä–∞–∑–µ–æ–ª–æ–≥–∏–∑–º–¥–µ—Ä–¥—ñ –¥“±—Ä—ã—Å –∞—É–¥–∞—Ä—É\n"
        "‚Ä¢ –ê—É–¥–∞—Ä–º–∞–Ω—ã “õ–∞–π—Ç–∞ –∂–∞—Å–∞—É –º“Ø–º–∫—ñ–Ω–¥—ñ–≥—ñ\n\n"
        "‚ö†Ô∏è **–®–µ–∫—Ç–µ—É–ª–µ—Ä:**\n"
        "‚Ä¢ –ú–∏–Ω—É—Ç—ã–Ω–∞ 15 —Å“±—Ä–∞—É (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API)\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 5000 —Ç–∞“£–±–∞\n\n"
        "–†–µ–∂–∏–º–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:",
        reply_markup=translation_modes_keyboard(),
        parse_mode="Markdown"
    )

# =======================
# –í–´–ë–û–† –†–ï–ñ–ò–ú–ê –ò RETRY
# =======================
user_modes = {}
last_translations = {}

@dp.callback_query()
async def mode_callback(query: types.CallbackQuery):
    user_id = query.from_user.id
    
    if query.data.startswith("retry_"):
        if user_id in last_translations:
            mode = user_modes.get(user_id, "”ô–¥–µ–±–∏")
            original_text = last_translations[user_id]
            
            await query.answer("üîÑ “ö–∞–π—Ç–∞ –∞—É–¥–∞—Ä—ã–ø –∂–∞—Ç—ã—Ä–º—ã–Ω...")
            await query.message.edit_text("‚è≥ –ë–∞—Å“õ–∞ –Ω“±—Å“õ–∞–¥–∞ –∞—É–¥–∞—Ä—ã–ø –∂–∞—Ç—ã—Ä–º—ã–Ω...")
            
            await perform_translation(query.message, original_text, mode, is_retry=True)
        else:
            await query.answer("‚ùå –ê–ª–¥—ã“£“ì—ã –º”ô—Ç—ñ–Ω —Ç–∞–±—ã–ª–º–∞–¥—ã", show_alert=True)
        return
    
    mode_map = {
        "mode_literal": "”ô–¥–µ–±–∏",
        "mode_academic": "–∞–∫–∞–¥–µ–º–∏—è–ª—ã“õ",
        "mode_simple": "–∫“Ø–Ω–¥–µ–ª—ñ–∫—Ç—ñ"
    }
    
    mode_names = {
        "”ô–¥–µ–±–∏": "üìö ”ò–¥–µ–±–∏",
        "–∞–∫–∞–¥–µ–º–∏—è–ª—ã“õ": "üéì –ê–∫–∞–¥–µ–º–∏—è–ª—ã“õ",
        "–∫“Ø–Ω–¥–µ–ª—ñ–∫—Ç—ñ": "üí¨ –ö“Ø–Ω–¥–µ–ª—ñ–∫—Ç—ñ"
    }
    
    selected_mode = mode_map.get(query.data, "”ô–¥–µ–±–∏")
    user_modes[user_id] = selected_mode
    
    await query.answer(f"–¢–∞“£–¥–∞–ª–¥—ã: {mode_names[selected_mode]}")
    await query.message.edit_text(
        f"‚úÖ –†–µ–∂–∏–º: **{mode_names[selected_mode]}**\n\n"
        "–ï–Ω–¥—ñ –º”ô—Ç—ñ–Ω–¥—ñ –∂—ñ–±–µ—Ä—ñ“£—ñ–∑ üëá",
        reply_markup=translation_modes_keyboard(),
        parse_mode="Markdown"
    )

# =======================
# –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–í–û–î–ê
# =======================
async def perform_translation(message: types.Message, text: str, mode: str, is_retry: bool = False):
    user_id = message.from_user.id
    
    can_request, wait_time = rate_limiter.can_request(user_id)
    if not can_request:
        await message.answer(
            f"‚è≥ –¢—ã–º –∫”©–ø —Å“±—Ä–∞—É –∂—ñ–±–µ—Ä–¥—ñ“£—ñ–∑.\n"
            f"–ö“Ø—Ç–µ —Ç“±—Ä—ã“£—ã–∑: {wait_time} —Å–µ–∫—É–Ω–¥.\n\n"
            f"üí° –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –ª–∏–º–∏—Ç—ñ: 15 —Å“±—Ä–∞—É/–º–∏–Ω—É—Ç"
        )
        return
    
    if not is_retry:
        last_translations[user_id] = text
    
    # =======================
    # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
    # =======================
    try:
        lang = detect(text)
    except:
        lang = "ru"

    # =======================
    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    # =======================
    if lang == "kk":
        task_text = f"""–ú”ô—Ç—ñ–Ω–¥—ñ “õ–∞–∑–∞“õ—à–∞ —Ç“Ø–∑–µ—Ç –∂”ô–Ω–µ –∂–∞“õ—Å–∞—Ä—Ç:

{text}

–¢–ê–ü–°–´–†–ú–ê:
- –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞–ª—ã“õ “õ–∞—Ç–µ–ª–µ—Ä–¥—ñ —Ç“Ø–∑–µ—Ç—É
- –°—Ç–∏–ª—å–¥—ñ –∂–∞“õ—Å–∞—Ä—Ç—É
- –¢–µ—Ä–º–∏–Ω–¥–µ—Ä–¥—ñ“£ –¥“±—Ä—ã—Å—Ç—ã“ì—ã–Ω —Ç–µ–∫—Å–µ—Ä—É
- –ú”ô—Ç—ñ–Ω–¥—ñ —Ç–∞–±–∏“ì–∏ –∂”ô–Ω–µ –∫”©—Ä–∫–µ–º –µ—Ç—É
- –°”©–π–ª–µ–º–¥–µ—Ä–¥—ñ“£ “õ“±—Ä—ã–ª—ã–º—ã–Ω –∂–∞“õ—Å–∞—Ä—Ç—É
- –¢–µ–∫ –Ω”ô—Ç–∏–∂–µ–Ω—ñ, –µ—à“õ–∞–Ω–¥–∞–π —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ—Å—ñ–∑ –∫”©—Ä—Å–µ—Ç"""
    else:
        task_text = f"""–ö–µ–ª–µ—Å—ñ –º”ô—Ç—ñ–Ω–¥—ñ “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–µ –∞—É–¥–∞—Ä:

{text}

–ú–ê“¢–´–ó–î–´ –ù“∞–°“ö–ê–£–õ–ê–†:
- –ö–æ–Ω—Ç–µ–∫—Å—Ç—ñ–Ω–µ –º“±“õ–∏—è—Ç –Ω–∞–∑–∞—Ä –∞—É–¥–∞—Ä
- –ñ–æ“ì–∞—Ä—ã–¥–∞“ì—ã –≥–ª–æ—Å—Å–∞—Ä–∏–π–¥–µ–≥—ñ —Ç–µ—Ä–º–∏–Ω–¥–µ—Ä–¥—ñ “õ–æ–ª–¥–∞–Ω
- –§—Ä–∞–∑–µ–æ–ª–æ–≥–∏–∑–º–¥–µ—Ä–¥—ñ “õ–∞–∑–∞“õ—à–∞ –±–∞–ª–∞–º–∞–ª–∞—Ä—ã–º–µ–Ω –∞–ª–º–∞—Å—Ç—ã—Ä
- –¢–∞–±–∏“ì–∏ –∂”ô–Ω–µ —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç—ñ “õ–∞–∑–∞“õ—à–∞ –º”ô—Ç—ñ–Ω –∂–∞—Å–∞
- –û—Ä–∏–≥–∏–Ω–∞–ª–¥—ã“£ –º–∞“ì—ã–Ω–∞—Å—ã–Ω —Ç–æ–ª—ã“õ —Å–∞“õ—Ç–∞
- –ú”ô–¥–µ–Ω–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ–≥–µ —Å–∞–π –∞—É–¥–∞—Ä
- Few-shot –º—ã—Å–∞–ª–¥–∞—Ä–¥—ã –µ—Å–∫–µ—Ä"""

    # =======================
    # –í—ã–∑–æ–≤ Gemini —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    # =======================
    max_retries = 3
    retry_count = 0
    
    while retry_count < max_retries:
        try:
            if not CURRENT_MODEL:
                await message.answer(
                    "‚ùå –ú–æ–¥–µ–ª—å “õ–æ–ª –∂–µ—Ç—ñ–º–¥—ñ –µ–º–µ—Å.\n"
                    "API –∫—ñ–ª—Ç—ñ–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –∫–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.\n\n"
                    "üí° Google AI Studio-–¥–∞ API –∫—ñ–ª—Ç—ñ“£—ñ–∑–¥—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑:\n"
                    "https://aistudio.google.com/app/apikey"
                )
                return
            
            model = genai.GenerativeModel(
                model_name=CURRENT_MODEL,
                system_instruction=SYSTEM_PROMPTS[mode]
            )

            temp = 0.8 if is_retry else 0.7
            
            response = model.generate_content(
                task_text,
                generation_config={
                    "temperature": temp,
                    "max_output_tokens": 2048,
                    "top_p": 0.95,
                    "top_k": 40
                }
            )
            
            result_text = response.text.strip()
            
            if len(result_text) > 4096:
                parts = [result_text[i:i+4000] for i in range(0, len(result_text), 4000)]
                for i, part in enumerate(parts):
                    if i == len(parts) - 1:
                        await message.answer(part, reply_markup=retry_keyboard(text))
                    else:
                        await message.answer(part)
            else:
                await message.answer(result_text, reply_markup=retry_keyboard(text))
            
            return
            
        except Exception as e:
            error_message = str(e)
            
            if "429" in error_message or "quota" in error_message.lower():
                await message.answer(
                    "‚ùå **API –ª–∏–º–∏—Ç—ñ —Ç–æ–ª–¥—ã**\n\n"
                    "üîç **–°–µ–±–µ–ø—Ç–µ—Ä:**\n"
                    "‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –ª–∏–º–∏—Ç—ñ –∞—è“õ—Ç–∞–ª–¥—ã\n"
                    "‚Ä¢ –¢—ã–º –∫”©–ø —Å“±—Ä–∞—É –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ\n\n"
                    "üí° **–®–µ—à—ñ–º–¥–µ—Ä:**\n"
                    "1Ô∏è‚É£ –ë—ñ—Ä–Ω–µ—à–µ –º–∏–Ω—É—Ç –∫“Ø—Ç—ñ“£—ñ–∑\n"
                    "2Ô∏è‚É£ Google AI Studio-–¥–∞ –∫–≤–æ—Ç–∞“£—ã–∑–¥—ã —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑:\n"
                    "   https://aistudio.google.com/app/apikey\n"
                    "3Ô∏è‚É£ –ñ–∞“£–∞ API –∫—ñ–ª—Ç –∂–∞—Å–∞“£—ã–∑\n"
                    "4Ô∏è‚É£ –¢”©–ª–µ–º–¥—ñ –∂–æ—Å–ø–∞—Ä“ì–∞ –∫”©—à—ñ“£—ñ–∑\n\n"
                    "‚è∞ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç: ~15 —Å“±—Ä–∞—É/–º–∏–Ω—É—Ç",
                    parse_mode="Markdown"
                )
                return
            
            elif "404" in error_message or "not found" in error_message.lower():
                if retry_count < max_retries - 1:
                    print(f"‚ö†Ô∏è –ú–æ–¥–µ–ª—å {CURRENT_MODEL} —Ç–∞–±—ã–ª–º–∞–¥—ã, –±–∞—Å“õ–∞–Ω—ã –∫”©—Ä–µ–π—ñ–∫...")
                    await select_best_model()
                    retry_count += 1
                    await asyncio.sleep(1)
                    continue
                else:
                    await message.answer(
                        "‚ùå **–ú–æ–¥–µ–ª—å —Ç–∞–±—ã–ª–º–∞–¥—ã**\n\n"
                        "“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –º–æ–¥–µ–ª—å–¥–µ—Ä–¥—ñ —Ç–µ–∫—Å–µ—Ä—É “Ø—à—ñ–Ω:\n"
                        "`python check_models.py`"
                    )
                    return
            
            else:
                print(f"API ERROR: {e}")
                await message.answer(
                    f"‚ùå “ö–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã.\n\n"
                    f"“ö–∞—Ç–µ: {error_message[:200]}\n\n"
                    f"–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑ –Ω–µ–º–µ—Å–µ —Ä–µ–∂–∏–º–¥—ñ ”©–∑–≥–µ—Ä—Ç—ñ“£—ñ–∑."
                )
                return

# =======================
# –û–°–ù–û–í–ù–û–ô –•–ï–ù–î–õ–ï–†
# =======================
@dp.message()
async def translate(message: types.Message):
    user_id = message.from_user.id
    mode = user_modes.get(user_id, "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π")
    text = message.text.strip()

    if not text:
        return

    if len(text) > 5000:
        await message.answer("‚ö†Ô∏è –ú”ô—Ç—ñ–Ω —Ç—ã–º “±–∑—ã–Ω (5000 —Ç–∞“£–±–∞–¥–∞–Ω –∞—Å–ø–∞—É—ã –∫–µ—Ä–µ–∫).")
        return

    processing_msg = await message.answer("‚è≥ –ê—É–¥–∞—Ä—ã–ø –∂–∞—Ç—ã—Ä–º—ã–Ω...")
    
    await perform_translation(message, text, mode)
    
    try:
        await processing_msg.delete()
    except:
        pass

# =======================
# RUN
# =======================
async def main():
    print("ü§ñ –ë–æ—Ç —ñ—Å–∫–µ “õ–æ—Å—ã–ª—É–¥–∞...")
    
    if await select_best_model():
        print(f"‚úÖ –ú–æ–¥–µ–ª—å —Ç–∞“£–¥–∞–ª–¥—ã: {CURRENT_MODEL}")
    else:
        print("‚ö†Ô∏è –ï–°–ö–ï–†–¢–£: –ú–æ–¥–µ–ª—å —Ç–∞“£–¥–∞–ª–º–∞–¥—ã, “õ–∞—Ç–µ–ª–µ—Ä –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω")
    
    print("üöÄ –ë–æ—Ç –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())